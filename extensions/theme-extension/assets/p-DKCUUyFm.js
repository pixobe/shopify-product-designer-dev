import{f as t}from"./p-Oqy8D2Bv.js";import{P as s}from"./p-1UZM8gEX.js";import{i as e,l as i,Q as h}from"./p-BOTfGNKw.js";import{P as n}from"./p-wEiFdH97.js";import{P as a}from"./p-gQj3JY6U.js";import{E as r,D as c,g as o,c as d,a as l}from"./p-DnVG-eLa.js";class u{static async createObject(t,e,i={}){i.stroke=i.stroke||e.stroke;const h=e.canvasWidth,r=e.canvasHeight,c=Math.floor(h/2),o=Math.floor(r/2);switch(i.top=o,i.left=c,t){case n.type:return n.create(h,r,i);case a.type:return a.create(i);case s.type:return s.from(i.src,i);default:throw new Error(`Unknown type ${t}`)}}static async create(t,s,e={}){return await u.createObject(t,s,e)}}class g{options;fabricCanvas;on=()=>{};stroke;etching;get gridObject(){return this.fabricCanvas.getObjects().find((t=>t.type===n.type))}get gridConfig(){return this.gridObject?.toJSON()}get src(){return this.options.media.url}constructor(t){this.options=t,this.on=this.options.listner,this.stroke=this.options.stroke??"#cccccc",this.etching=!0===this.options.etching}async build(){this.fabricCanvas=new i(this.options.canvas,{preserveObjectStacking:!0});const t=this.options.media;return this.options.data?await this.fabricCanvas.loadFromJSON(this.options.data):this.fabricCanvas.backgroundImage=await s.from(t.url),this.resize(),this.addGrid(this.options.media.grid),function(t){t.upperCanvasEl.style.touchAction="none";const s=(t,s=1,e=3)=>Math.min(Math.max(t,s),e),i=s=>{const i=t.viewportTransform;if(i)if(s<=1)t.absolutePan(new e(0,0));else{const e=t.getWidth()-1e3*s,h=t.getHeight()-1e3*s;i[4]=Math.min(0,Math.max(i[4],e)),i[5]=Math.min(0,Math.max(i[5],h))}};t.on("mouse:wheel",(h=>{const n=h.e;let a=t.getZoom()*Math.pow(.999,n.deltaY);a=s(a);const r=new e(n.offsetX,n.offsetY);t.zoomToPoint(r,a),n.preventDefault(),n.stopPropagation(),i(a),t.requestRenderAll()}));let h=!1,n=!1,a=0,r=t.getZoom(),c=null,o=!0;const d=(t,s)=>{const e=t.clientX-s.clientX,i=t.clientY-s.clientY;return Math.sqrt(e*e+i*i)},l=t.upperCanvasEl;l.addEventListener("touchstart",(s=>{if(2===s.touches.length)s.preventDefault(),h=!0,a=d(s.touches[0],s.touches[1]),r=t.getZoom();else if(1===s.touches.length&&!h){s.preventDefault();const i=s.touches[0];c=new e(i.clientX,i.clientY);const h=t.findTarget(s);o=!h&&t.getZoom()>1,n=o}}),{passive:!1}),l.addEventListener("touchmove",(u=>{if(h&&2===u.touches.length){u.preventDefault();const h=d(u.touches[0],u.touches[1]);let n=s(r*(h/a));const c=l.getBoundingClientRect(),o=new e((u.touches[0].clientX+u.touches[1].clientX)/2-c.left,(u.touches[0].clientY+u.touches[1].clientY)/2-c.top);t.zoomToPoint(o,n),i(n),t.requestRenderAll()}else if(n&&o&&1===u.touches.length){u.preventDefault();const s=u.touches[0],i=new e(s.clientX,s.clientY);if(c){const s=new e(i.x-c.x,i.y-c.y);t.relativePan(s)}c=i,t.requestRenderAll()}}),{passive:!1});const u=()=>{h=!1,n=!1,c=null,o=!0};l.addEventListener("touchend",u),l.addEventListener("touchcancel",u)}(this.fabricCanvas),await this.updateStroke(this.stroke),this.addEventListeners(),this.setupInitialState(),this.fabricCanvas.requestRenderAll(),this}addEventListeners=()=>{const t=this.fabricCanvas;this.options.hideGridOnDeselect&&(t.on("on:edit",(t=>{t.target&&this.on("edit",{selected:t.target})})),t.on("on:delete",(t=>{t.target&&this.on("delete",{target:t.target})})),t.on("selection:created",(t=>{const s=this.gridObject;s&&s.set({visible:!0});const e=t.selected[0];e&&e.set({borderColor:"#ffffff",borderScaleFactor:2})})),t.on("selection:cleared",(()=>{const t=this.gridObject;t&&t.set({visible:!1}),this.on("selection:cleared",{})})),t.on("selection:updated",(()=>{this.on("selection:updated",{})})),t.on("object:modified",(s=>{const e=this.gridObject,i=s.target;if("rotate"===s.action&&this.options.snapAngle){const s=(h=this.options.snapAngle,Math.round((i.angle+360)%360/h)*h);i.rotate(s),i.setCoords(),t.requestRenderAll()}var h;if(e){const t=!i.isContainedWithinObject(e);this.on("breach",{breached:t})}})))};resize(){const t=this.fabricCanvas,s=t.backgroundImage,e=Math.floor(s.width*s.scaleX),i=Math.floor(s.height*s.scaleY),n=h.findScaleToFit({width:e,height:i},t);this.scaleAndPositionObject(s,n),t.setDimensions({width:e*n,height:i*n}),this.scaleAndPositionObjects(n)}setupInitialState(){const t=this.fabricCanvas.getObjects();if(this.options.viewonly){for(const s of t)s.set({selectable:!1});this.fabricCanvas.requestRenderAll()}}async addGrid(t){if(!t||!0===this.options.hideGrid)return;t.id="grid",t.selectable=this.options.gridEditable,t.evented=this.options.gridEditable,t.stroke=this.options.media.stroke,t.visible=!1===this.options.hideGrid;const s=await u.create(n.type,this.factorySettings,t);this.fabricCanvas.add(s),this.fabricCanvas.requestRenderAll()}get factorySettings(){return{centerPoint:(this.gridObject||this.fabricCanvas).getCenterPoint(),width:Math.floor(this.gridObject?.getScaledWidth()||this.fabricCanvas.width/2),height:Math.floor(this.gridObject?.getScaledHeight()||this.fabricCanvas.height/2),canvasWidth:this.fabricCanvas.getWidth(),canvasHeight:this.fabricCanvas.getHeight(),stroke:this.stroke}}async addObject(t,s){const e=this.factorySettings,i=await u.create(t,e,s),n=h.findScaleToFit(i,e);return i.scale(.8*n),i.setPositionByOrigin(e.centerPoint,"center","center"),this.options.etching&&await r.create(i,this.stroke),this.fabricCanvas.add(i),i.setCoords(),this.fabricCanvas.requestRenderAll(),i}async updateObject(t,s){return t.set(s),this.options.etching&&await r.create(t,this.stroke),t.setCoords(),this.fabricCanvas.requestRenderAll(),t}findObjectById(t){return this.fabricCanvas.getObjects().find((s=>s.id===t))}removeObjectById(t){const s=this.findObjectById(t);s&&(this.fabricCanvas.remove(s),this.fabricCanvas.requestRenderAll())}removeObject(t){t&&(this.fabricCanvas.remove(t),this.fabricCanvas.requestRenderAll())}getSelectedObject(){return this.fabricCanvas.getActiveObject()}scaleAndPositionObjects(t){this.fabricCanvas.getObjects().forEach((s=>{this.scaleAndPositionObject(s,t)}))}scaleAndPositionObject(t,s){t.set({scaleX:t.scaleX*s,scaleY:t.scaleY*s,left:t.left*s,top:t.top*s}),t.setCoords()}discardObject(){this.fabricCanvas.discardActiveObject(),this.fabricCanvas.requestRenderAll()}async updateStroke(t){if(t){if(this.stroke=t,this.options.etching)await Promise.all(this.fabricCanvas.getObjects().map((s=>r.create(s,t))));else{const s=this.gridObject;s?.set({stroke:t})}this.fabricCanvas.requestRenderAll()}}clone=async t=>{const s=this.fabricCanvas,e=s.toJSON(),h=document.createElement("canvas");h.width=s.width,h.height=s.height;const n=new i(h,{});!0!==t&&delete e.backgroundImage;const a=await n.loadFromJSON(e);return this.options.etching&&await Promise.all(a.getObjects().map((async t=>await c.create(t,"#000000")))),a.requestRenderAll(),a};toObject(){return this.fabricCanvas.toDatalessObject()}}class f{options;el;fabricAdapters=[];index=0;activeRoute;currentObject;constructor(t){this.options=t}get adapter(){return this.fabricAdapters[this.index]}get stroke(){return this.config.stroke||"#c0c0c0"}get meta(){return this.options.meta}get media(){return this.options.media}get curentMedia(){return this.media[this.index]}get config(){return this.options.config}get fonts(){return this.options.config.fonts||[]}get gallery(){return this.options.config.gallery||[]}get endpoint(){return this.options.config.endpoint}get endpointHeaders(){return this.options.config.endpointHeaders||{}}get etching(){return this.adapter.etching}get aihelpContent(){return this.options.config.aihelpContent}get supportContent(){return this.options.config.supportContent||""}get facebook(){return this.options.config.facebook}get whatsapp(){return this.options.config.whatsapp}get designData(){return this.fabricAdapters.map((t=>t.toObject()))}get isImageGenConfigured(){return void 0!==this.options.config.aimodel}get mediaItems(){return this.fabricAdapters.map((t=>({src:t.src,etching:t.etching,stroke:t.stroke,grid:t.gridConfig})))}async init(s){this.el=s,await Promise.all(this.fonts.map(t));for(let t=0;t<this.options.media.length;t++){const e=this.options.media[t],i=this.options.data?.[t]||null,h=s.shadowRoot?.querySelector(`canvas[data-index="${t}"]`),n={etching:e.etching??this.options.config.etching??!1,stroke:e.grid?.stroke||this.stroke,canvas:h,data:i,snapAngle:this.options.config?.snapAngle,media:e,gridEditable:this.options.gridEditable,viewonly:this.options.viewonly,hideGrid:this.options.hideGrid,hideGridOnDeselect:this.options.hideGridOnDeselect,listner:this.emit},a=await new g(n).build();this.fabricAdapters.push(a)}}mediaItemAt(t){return this.mediaItems[t]}setIndex(t){if(t<0||t>=this.fabricAdapters.length)throw new Error("Index out of bounds");this.index=t}async update(t,s){const e=this.adapter;this.currentObject?await e.updateObject(this.currentObject,s):await e.addObject(t,s)}deleteObjectById(t){this.adapter.removeObjectById(t)}async toggleGrid(t){if(t){const t=this.curentMedia.grid||n.defaults;await this.update(n.type,t)}else this.adapter.removeObjectById("grid")}async toggleObject(t,s,e={}){t?await this.adapter.addObject(s,e):this.adapter.removeObjectById(e.id)}emit=async(t,s={})=>{switch(t){case"close":this.close();break;case"breach":s.breached?this.el.classList.add("error"):this.el.classList.remove("error");break;case"edit":{const t=s.selected;if(t){const e=o(t.type);e&&(this.currentObject=s.selected,this.route(e,this.currentObject?.toObject()))}break}case"delete":this.adapter.removeObject(s.target),this.currentObject=null;break;case"selection:cleared":this.currentObject=null,this.close();break;case"selection:updated":this.close(!0)}};route=(t,s)=>{const e=this.el.shadowRoot?.querySelector("router-outlet");if(e){const i=document.createElement(t);i.props=s,i.controller=this,e.classList.add("open"),e.classList.remove("close"),e.replaceChildren(i),this.activeRoute=i}};routeUpdate(t,s){this.activeRoute&&Object.assign(this.activeRoute,{[t]:s})}close=(t=!1)=>{const s=this.el.shadowRoot?.querySelector("router-outlet");this.activeRoute&&(s.classList.remove("open"),s.classList.add("close"),s.innerHTML="",this.activeRoute=void 0,t||(this.adapter.discardObject(),this.currentObject=null))};addFont(t){let s=this.fonts;s||(s=[]),this.config.fonts=[...s,t]}deleteFont(t){const s=this.fonts.findIndex((s=>s.name==t));this.fonts.splice(s,1),this.config.fonts=[...this.fonts]}addGallery(t){let s=this.gallery;s||(s=[]),this.config.gallery=[...s,t]}deleteGallery(t){const s=this.gallery.findIndex((s=>s.name==t));this.gallery.splice(s,1),this.config.gallery=[...this.gallery]}deleteGalleryImage(t,s){const e=this.gallery.find((s=>s.name==t));if(e){const t=e.images.findIndex((t=>t.url===s));e.images.splice(t,1),e.images=[...e.images]}this.config.gallery=[...this.gallery]}async setStroke(t){await this.adapter.updateStroke(t)}setMediaEtching(t){this.adapter.etching=t}downloadPdf=async(t="order",s=!0)=>new Promise((e=>{setTimeout((async()=>{const i=(await this.adapter.clone(s)).toDataURL({format:"png",multiplier:8});return e(d(i,t,8))}),200)}));downloadSvg=(t="order",s=!0)=>new Promise((e=>{setTimeout((async()=>{const i=(await this.adapter.clone(s)).toSVG({suppressPreamble:!0});return e(l(i,t))}),200)}))}export{f as C}